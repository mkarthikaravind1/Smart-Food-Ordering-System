<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Checkout - BiteBurst</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; padding-top: 70px; }
        .restaurant-card { border-radius: 10px; background-color: #fff; margin-bottom: 20px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .restaurant-name { font-weight: 600; margin-bottom: 10px; }
        .item-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .item-row img { width: 60px; height: 60px; border-radius: 8px; margin-right: 10px; }
        .item-details { flex-grow: 1; }
        .payment-option { display: flex; align-items: center; margin-bottom: 10px; }
        .payment-option input { margin-right: 10px; }
        #card-details, #upi-details { margin-top: 15px; }
        #upi-details img { width: 150px; margin-bottom: 10px; }
        .invalid-feedback { display: none; color: red; font-size: 0.9rem; }
        input:invalid { border-color: red; }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-3 fixed-top">
        <a class="navbar-brand" href="index.html">üçî BiteBurst</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="menu.html">Menu</a></li>
                <li class="nav-item"><a class="nav-link" href="cart.html">Cart</a></li>
            </ul>
        </div>
    </nav>

    <div class="container my-5">
        <h2 class="mb-4">Order Summary & Payment</h2>

        <!-- Order Summary -->
        <div id="order-summary"></div>
        <h4 class="mt-3">Grand Total: ‚Çπ<span id="grand-total">0</span></h4>

        <!-- Payment Form -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">Payment Options</h5>
                <form id="paymentForm">
                    <div class="payment-option">
                        <input type="radio" name="paymentMethod" value="card" id="card" required>
                        <label for="card">Credit/Debit Card</label>
                    </div>
                    <div class="payment-option">
                        <input type="radio" name="paymentMethod" value="upi" id="upi">
                        <label for="upi">UPI</label>
                    </div>
                    <div class="payment-option">
                        <input type="radio" name="paymentMethod" value="cod" id="cod">
                        <label for="cod">Cash on Delivery</label>
                    </div>

                    <!-- Card Details -->
                    <div id="card-details">
                        <div class="mb-3">
                            <label for="cardName" class="form-label">Cardholder Name</label>
                            <input type="text" class="form-control" id="cardName">
                            <div class="invalid-feedback">Enter a valid name</div>
                        </div>
                        <div class="mb-3">
                            <label for="cardNumber" class="form-label">Card Number</label>
                            <input type="text" class="form-control" id="cardNumber" maxlength="16">
                            <div class="invalid-feedback">Card number must be 16 digits</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="expiry" class="form-label">Expiry Date</label>
                                <input type="month" class="form-control" id="expiry">
                                <div class="invalid-feedback">Enter expiry date</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="cvv" class="form-label">CVV</label>
                                <input type="password" class="form-control" id="cvv" maxlength="3">
                                <div class="invalid-feedback">CVV must be 3 digits</div>
                            </div>
                        </div>
                    </div>

                    <!-- UPI Details -->
                    <div id="upi-details" style="display:none;">
                        <p>Scan the QR code or enter your UPI ID:</p>
                        <img src="img/upi-qr.png" alt="UPI QR Code">
                        <input type="text" class="form-control" id="upiId" placeholder="example@upi">
                        <div class="invalid-feedback">Enter a valid UPI ID</div>
                    </div>

                    <button type="submit" class="btn btn-success w-100 mt-3">Confirm Payment</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const orderSummaryEl = document.getElementById("order-summary");
        const grandTotalEl = document.getElementById("grand-total");
        const cart = JSON.parse(localStorage.getItem("cart")) || [];

        if(cart.length === 0){
            orderSummaryEl.innerHTML = "<p class='text-muted'>Your cart is empty!</p>";
        } else {
            const grouped = {};
            cart.forEach(item => {
                if(!grouped[item.restaurant]) grouped[item.restaurant] = [];
                grouped[item.restaurant].push(item);
            });

            let grandTotal = 0;
            for(let restaurant in grouped){
                let restaurantTotal = 0;
                const restaurantDiv = document.createElement("div");
                restaurantDiv.className = "restaurant-card";

                let itemsHTML = "";
                grouped[restaurant].forEach(item => {
                    const priceNum = parseInt(item.price.replace(/[^\d]/g, "")) || 0;
                    const quantity = item.quantity || 1;
                    restaurantTotal += priceNum * quantity;

                    itemsHTML += `<div class="item-row">
                                    <img src="${item.image}" alt="${item.item}">
                                    <div class="item-details">
                                        <span class="fw-bold">${item.item}</span><br>
                                        <span class="text-muted">${quantity} x ‚Çπ${priceNum}</span>
                                    </div>
                                    <span>‚Çπ${priceNum * quantity}</span>
                                  </div>`;
                });

                grandTotal += restaurantTotal;

                restaurantDiv.innerHTML = `
                    <h5 class="restaurant-name">${restaurant}</h5>
                    ${itemsHTML}
                    <div class="text-end fw-bold mt-2">Subtotal: ‚Çπ${restaurantTotal}</div>
                `;
                orderSummaryEl.appendChild(restaurantDiv);
            }
            grandTotalEl.innerText = grandTotal;
        }

        const cardDetails = document.getElementById("card-details");
        const upiDetails = document.getElementById("upi-details");
        const paymentRadios = document.querySelectorAll('input[name="paymentMethod"]');

        paymentRadios.forEach(radio => {
            radio.addEventListener("change", () => {
                if(radio.value === "card" && radio.checked){
                    cardDetails.style.display = "block";
                    upiDetails.style.display = "none";
                } else if(radio.value === "upi" && radio.checked){
                    cardDetails.style.display = "none";
                    upiDetails.style.display = "block";
                } else {
                    cardDetails.style.display = "none";
                    upiDetails.style.display = "none";
                }
            });
        });

        document.getElementById("paymentForm").addEventListener("submit", (e) => {
            e.preventDefault();
            if(cart.length === 0){
                alert("Cart is empty!");
                return;
            }

            const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            let valid = true;

            if(selectedMethod === "card"){
                const cardNumber = document.getElementById("cardNumber");
                const cvv = document.getElementById("cvv");
                const name = document.getElementById("cardName");
                const expiry = document.getElementById("expiry");

                if(cardNumber.value.length !== 16){ valid = false; cardNumber.nextElementSibling.style.display="block"; } else { cardNumber.nextElementSibling.style.display="none"; }
                if(cvv.value.length !== 3){ valid = false; cvv.nextElementSibling.style.display="block"; } else { cvv.nextElementSibling.style.display="none"; }
                if(!name.value.trim()){ valid = false; name.nextElementSibling.style.display="block"; } else { name.nextElementSibling.style.display="none"; }
                if(!expiry.value){ valid = false; expiry.nextElementSibling.style.display="block"; } else { expiry.nextElementSibling.style.display="none"; }
            } else if(selectedMethod === "upi"){
                const upiId = document.getElementById("upiId");
                const upiRegex = /^[\w.-]+@[\w]{2,}$/;
                if(!upiRegex.test(upiId.value.trim())){ valid=false; upiId.nextElementSibling.style.display="block"; } else { upiId.nextElementSibling.style.display="none"; }
            }

            if(!valid) return;

            // Save order
            const orders = JSON.parse(localStorage.getItem("orders")) || [];
            orders.push({
                id: Date.now(),
                items: cart,
                date: new Date().toLocaleDateString()
            });
            localStorage.setItem("orders", JSON.stringify(orders));

            localStorage.removeItem("cart");
            alert("Payment successful! Your order has been placed.");
            window.location.href = "index.html";
        });
    </script>
</body>
</html>
